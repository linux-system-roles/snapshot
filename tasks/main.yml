# SPDX-License-Identifier: MIT
---
- name: Set platform/version specific variables
  include_tasks: tasks/set_vars.yml

- name: Ensure required packages are installed
  package:
    name: "{{ __snapshot_packages }}"
    state: present
    use: "{{ (__snapshot_is_ostree | d(false)) |
              ternary('ansible.posix.rhel_rpm_ostree', omit) }}"

- name: Show snapshot command
  debug:
    var: __snapshot_cmd
    verbosity: 2

- name: Run snapshot command {{ snapshot_lvm_action }}
  ansible.builtin.script: "{{ __snapshot_cmd }}"
  args:
    executable: "{{ __snapshot_python }}"
  register: snapshot_cmd_raw
  no_log: true
  ignore_errors: true  # noqa: ignore-errors - handled below
  changed_when: false  # change handled below too

- name: Print out response
  debug:
    var: snapshot_cmd_raw
    verbosity: 2

- name: Parse raw output
  set_fact:
    snapshot_cmd: "{{ snapshot_cmd_raw.stdout | from_json }}"
  changed_when: snapshot_cmd["changed"]

- name: Set snapshot_facts to the JSON results
  set_fact:
    snapshot_facts: "{{ snapshot_cmd['data'] }}"
  when: snapshot_lvm_action == "list"

- name: Show errors
  debug:
    msg: "{{ snapshot_cmd['errors'] }}"
  when: snapshot_cmd["return_code"] != 0
  failed_when:
    - snapshot_cmd_raw is failed or snapshot_cmd["return_code"] != 0
