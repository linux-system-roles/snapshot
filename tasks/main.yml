# SPDX-License-Identifier: MIT
---
- name: Set platform/version specific variables
  include_tasks: tasks/set_vars.yml

- name: Ensure required packages are installed
  package:
    name: "{{ __snapshot_packages }}"
    state: present
    use: "{{ (__snapshot_is_ostree | d(false)) |
              ternary('ansible.posix.rhel_rpm_ostree', omit) }}"

- name: Run snapshot command {{ snapshot_lvm_action }}
  ansible.builtin.script: "{{ __snapshot_cmd }}"
  args:
    executable: "{{ __snapshot_python }}"
  register: snapshot_cmd
  no_log: true
  ignore_errors: true  # noqa: ignore-errors - handled below

- name: Print out response
  debug:
    var: snapshot_cmd.stdout
    verbosity: 2

- name: Set snapshot_facts to the JSON results
  set_fact:
    snapshot_facts: "{{ snapshot_cmd.stdout | from_json }}"
  when: snapshot_lvm_action == "list"

- name: Show errors
  debug:
    msg: "{{ snapshot_cmd.stderr }}"
  when: snapshot_cmd.rc != 0
  failed_when: snapshot_cmd.rc != 0
